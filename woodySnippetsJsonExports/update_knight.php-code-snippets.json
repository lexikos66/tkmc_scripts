{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:29","snippets":[{"name":"update_knight","title":"update_knight","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\nrequire_once(SCRIPTS_DIR.'\/includes\/form_functions.inc');\r\n\t\r\n\/\/Connect To Database\r\n$db = LocalDatabase::getReadable('master');\r\n$lodgetable='lodge_directory';\r\n$ktable='knight_directory';\r\n$knightNum='';\r\n$lodgeNum='';\r\n$lodge_council=false;\r\n$grand_council=false;\r\n$self_only=false;\r\n\r\n$current_user = wp_get_current_user();\r\n$roles = implode('\",\"',$current_user->roles);\r\nif(in_array(\"grand_council\", $current_user->roles)) { $grand_council=true; }\r\nif(in_array(\"lodge_council\", $current_user->roles)) { $lodge_council=true; }\r\nif(!$lodge_council && !$grand_council) { $self_only=true; }\r\n$query = 'SELECT * FROM ' . $lodgetable . ' WHERE LODGE_CODE in (\"'. $roles .'\")';\r\n$result = mysqli_query($db->connection, $query);\r\nif($result) {\r\n    while($row = mysqli_fetch_array($result)){\r\n        $lodgeNum = $row['LODGE_NUM'];\r\n    }\r\n}\r\n\r\nif($grand_council) { $lodgeNum = 0; }\r\n\r\nif($self_only) {\r\n    $query = 'SELECT * FROM ' . $ktable . ' WHERE NICKNAME=\"' . $current_user->display_name . '\" AND LODGE=\"' . $lodgeNum . '\"';\r\n    $result = mysqli_query($db->connection, $query);\r\n    if($result) {\r\n        $row = mysqli_fetch_array($result);\r\n        $knightNum = $row['RECORD_NUM'];\r\n    }\r\n}\r\n\r\nif(isset($_GET[\"success\"])) {\r\n\t$query = 'SELECT * FROM ' . $ktable . ' WHERE RECORD_NUM = ' . $_GET[\"knightNum\"];\r\n    $result = mysqli_query($db->connection, $query);\r\n    if($result) {\r\n\t\t$row = mysqli_fetch_array($result);\r\n\t\techo '<p>You successfully updated the record for ' . $row['FNAME'] . ' ' . $row['LNAME'] . '.<\/p>';\r\n    }\r\n}\r\n\r\nif(isset($_GET[\"knightNum\"]) || $self_only) {\r\n    if(!$self_only) {\r\n        $knightNum = $_GET['knightNum'];\r\n    }\r\n    $query = 'SELECT * FROM ' . $ktable . ' WHERE RECORD_NUM = ' . $knightNum;\r\n    $result = mysqli_query($db->connection, $query);\r\n    if($result) {\r\n\t\t$row = mysqli_fetch_array($result);\r\n\t\techo '<p>You are modifying ' . $row['FNAME'] . ' ' . $row['LNAME'] . '.<\/p>';\r\n    }\r\n} \r\n\r\nif(!$self_only && !isset($_GET[\"knightNum\"])) {\r\n    echo '<form action=\"http:\/\/member.templarknightsmc.com\/knights\/update-knight\" method=\"get\">';\r\n    members_dropdown($db, $ktable, true, $lodgeNum, 'Who do you want to update?');\r\n    echo '<input type=\"submit\" value=\"Find Individual!\"><\/form>';\r\n    echo '<p><hr><\/p>';\r\n}\r\n\r\nif(isset($_GET['knightNum']) || $self_only) {\r\n\techo '<form action=\"http:\/\/templarknightsmc.com\/scripts\/updateknight_action.php\" method=\"post\">';\r\n\t$query = 'SELECT * FROM ' .  $ktable . ' WHERE RECORD_NUM = ' . $knightNum;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\tif($result) {\r\n\t\t$row = mysqli_fetch_array($result);\r\n\t\tif ($grand_council) {\r\n\t\t\techo '<p>TKMC Record Number: <input type=\"text\" name=\"tkmcNum\" value=\"' . $row['TKMC_NUM'] . '\" \/><\/p>';\r\n\t\t} else {\r\n\t\t\techo '<p>TKMC Record Number: '. $row['TKMC_NUM'] . '<\/p>\r\n\t\t\t<input type=\"hidden\" name=\"tkmcNum\" value=\"'.$row['TKMC_NUM'].'\" \/>';\r\n\t\t}\r\n\t\techo 'First Name: <input type=\"text\" name=\"firstName\" value=\"' . $row['FNAME'] . '\" \/><p>';\r\n\t\techo 'Last Name: <input type=\"text\" name=\"lastName\" value=\"' . $row['LNAME'] . '\" \/><p>';\r\n\t\techo 'Birth Date (yyyy-mm-dd): <input type=\"text\" name=\"birthDate\" value=\"' . $row['BIRTH_DATE'] . '\" \/><p>';\r\n\t\techo 'Nickname: <input type=\"text\" name=\"nickName\" value=\"' . $row['NICKNAME'] . '\" \/><p>';\r\n\t\tif ($grand_council) {\r\n\t\t\trank_dropdown($db, $ktable, $row['RANK']);\r\n\t\t} else {\r\n\t\t\techo 'Rank: '.$row['RANK'];\r\n\t\t\techo '<input type=\"hidden\" name=\"rank\" value=\"' . get_rank($db, $ktable, $row['RANK']) . '\" \/>';\r\n\t\t}\r\n\t\techo '<\/p>';\r\n\t\techo 'Street Address: <input type=\"text\" name=\"streetAddress\" value=\"' . $row['STREET_ADDRESS'] . '\" \/><p>';\r\n\t\techo 'City: <input type=\"text\" name=\"city\" value=\"' . $row['CITY'] . '\" \/><p>';\r\n\t\techo '<p>State:';\r\n\t\techo '<select name=\"state\">';\r\n\t\t$usertable='state_directory';\r\n\t\t$query = 'SELECT * FROM ' . $usertable;\r\n\t\t$stateresult = mysqli_query($db->connection, $query);\r\n\t\tif($stateresult) {\r\n\t\t\twhile($staterow = mysqli_fetch_array($stateresult)){\r\n\t\t\t\tif($staterow['STATE_NUM'] == $row['STATE']) {\r\n\t\t\t\t\techo '<option selected=\"yes\" value=\"' . $staterow['STATE_NUM'] . '\">' . $staterow['STATE_NAME'] . '<\/option>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<option value=\"' . $staterow['STATE_NUM'] . '\">' . $staterow['STATE_NAME'] . '<\/option>';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\techo '<\/select><\/p>';\r\n\t\techo 'Zip Code: <input type=\"text\" name=\"zipCode\" value=\"' . $row['ZIP_CODE'] . '\" \/><p>';\r\n\t\techo '<p>Country:';\r\n\t\techo '<select name=\"country\">';\r\n\t\t$usertable='country_directory';\r\n\t\t$query = 'SELECT * FROM ' . $usertable;\r\n\t\t$countryresult = mysqli_query($db->connection, $query);\r\n\t\tif($countryresult) {\r\n\t\t\twhile($countryrow = mysqli_fetch_array($countryresult)){\r\n\t\t\t\tif($countryrow['COUNTRY_NUM'] == $row['COUNTRY']) {\r\n\t\t\t\t\techo '<option selected=\"yes\" value=\"' . $countryrow['COUNTRY_NUM'] . '\">' . $countryrow['COUNTRY_NAME'] . '<\/option>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<option value=\"' . $countryrow['COUNTRY_NUM'] . '\">' . $countryrow['COUNTRY_NAME'] . '<\/option>';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\techo '<\/select><\/p>';\r\n\t\techo 'Phone (no dashes): <input type=\"text\" name=\"phoneNum\" value=\"' . $row['PHONE'] . '\" \/><p>';\r\n\t\techo 'Email Address: <input type=\"text\" name=\"emailAddr\" value=\"' . $row['EMAIL'] . '\" \/><p>';\r\n\t\techo '<p>Lodge:';\r\n\t\techo '<select name=\"lodgeNum\">';\r\n\t\t$lodgeArray = \"\";\r\n\t\t$usertable='lodge_directory';\r\n\t\t$query = 'SELECT * FROM ' . $usertable;\r\n\t\t$lodgeresult = mysqli_query($db->connection, $query);\r\n\t\tif($lodgeresult) {\r\n\t\t\twhile($lodgerow = mysqli_fetch_array($lodgeresult)){\r\n\t\t\t\t$lodgeArray[$lodgerow['LODGE_NUM']] = $lodgerow['LODGE_NAME'];\r\n\t\t\t\tif ($grand_council) {\r\n\t\t\t\t\tif($lodgerow['LODGE_NUM'] == $row['LODGE']) {\r\n\t\t\t\t\t\techo '<option selected=\"yes\" value=\"' . $lodgerow['LODGE_NUM'] . '\">' . $lodgerow['LODGE_NAME'] . '<\/option>';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\techo '<option value=\"' . $lodgerow['LODGE_NUM'] . '\">' . $lodgerow['LODGE_NAME'] . '<\/option>';\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\tif ($lodgerow['LODGE_NUM'] == $row['LODGE']) {\r\n\t\t\t\t\t\techo '<option selected=\"yes\" value=\"'.$lodgerow['LODGE_NUM'].'\">'.$lodgerow['LODGE_NAME'].'<\/option>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\techo '<\/select><\/p>';\r\n\t\t}\r\n\t\techo 'Referred by (use nickname if posible): <input type=\"text\" name=\"referredBy\" value=\"' . $row['REFERRED_BY'] . '\"\/><p>';\r\n\t\techo '<p>Mentor:';\r\n\t\techo '<select name=\"mentor\">';\r\n\t\techo '<option value=\"\">--- Select ---<\/option>';\r\n\t\t$usertable='knight_directory';\r\n\t\t$query = 'SELECT * FROM ' . $usertable . ' ORDER BY LODGE, NICKNAME';\r\n\t\t$mentorresult = mysqli_query($db->connection, $query);\r\n\t\tif($mentorresult) {\r\n\t\t\twhile($mentorrow = mysqli_fetch_array($mentorresult)) {\r\n\t\t\t\tif($mentorrow['RANK'] != \"Provisional\" && $mentorrow['RANK'] != \"Honorary\") {\r\n\t\t\t\t\tif($mentorrow['RECORD_NUM'] == $row['MENTOR']) {\r\n\t\t\t\t\t\techo '<option selected=\"yes\" value=\"' . $mentorrow['RECORD_NUM'] . '\">' . $mentorrow['FNAME'] . ' \"' . $mentorrow['NICKNAME'] . '\" ' . $mentorrow['LNAME'] . ' [' . $lodgeArray[$mentorrow['LODGE']] . ']<\/option>';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\techo '<option value=\"' . $mentorrow['RECORD_NUM'] . '\">' . $mentorrow['FNAME'] . ' \"' . $mentorrow['NICKNAME'] . '\" ' . $mentorrow['LNAME'] . ' [' . $lodgeArray[$mentorrow['LODGE']] . ']<\/option>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\techo '<\/select><\/p>';\r\n\t\techo '<b>Please enter all Dates in the format of yyyy-mm-dd <\/b><br>';\r\n\t\tif ($grand_council) {\r\n\t\t\techo 'Date Applied: <input type=\"text\" name=\"dateApplied\" value=\"' . $row['DATE_JOINED'] . '\" \/><p>';\r\n\t\t} else {\r\n\t\t\techo 'Date Applied: '. $row['DATE_JOINED'] . '<p>';\r\n\t\t\techo '<input type=\"hidden\" name=\"dateApplied\" value=\"' . $row['DATE_JOINED'] . '\" \/>';\r\n\t\t}\r\n\t\tif ($grand_council) {\r\n\t\t\techo 'Date Approved: <input type=\"text\" name=\"dateApproved\" value=\"' . $row['DATE_APPROVED'] . '\" \/><p>';\r\n\t\t} else {\r\n\t\t\techo 'Date Approved: '. $row['DATE_APPROVED'] . '<p>';\r\n\t\t\techo '<input type=\"hidden\" name=\"dateApproved\" value=\"' . $row['DATE_APPROVED'] . '\" \/>';\r\n\t\t}\r\n\t\tif ($grand_council) {\t\t\r\n\t\t\techo 'Date Knighted: <input type=\"text\" name=\"dateKnighted\" value=\"' . $row['DATE_KNIGHTED'] . '\" \/><p>';\r\n\t\t} else {\r\n\t\t\techo 'Date Knighted: '. $row['DATE_KNIGHTED'] . '<p>';\r\n\t\t\techo '<input type=\"hidden\" name=\"dateKnighted\" value=\"' . $row['DATE_KNIGHTED'] . '\" \/>';\r\n\t\t}\r\n\t\tif ($grand_council) {\r\n            echo 'Date Withdrew: <input type=\"text\" name=\"dateWithdrew\" value=\"' . $row['DATE_WITHDREW'] . '\" \/><p>';\r\n        } else {\r\n            echo 'Date Withdrew: '. $row['DATE_WITHDREW'] . '<p>';\r\n            echo '<input type=\"hidden\" name=\"dateWithdrew\" value=\"' . $row['DATE_WITHDREW'] . '\" \/><p>';\r\n        }\r\n\t\techo 'Notes: <input type=\"textarea\" name=\"notes\" value=\"' . $row['NOTES'] . '\" \/><p>';\r\n\t\techo '<input type=\"hidden\" name=\"recordNum\" value=\"' . $row['RECORD_NUM'] . '\" \/>';\r\n\t\techo '<input type=\"hidden\" name=\"grandCouncil\" value=\"'.$grand_council.'\" \/>';\r\n\t\techo '<p><input type=\"submit\" value=\"Update Record\"><\/p>';\r\n\t}\r\n}\r\necho '<\/form>';\r\nmysqli_close($db->connection);","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP Script to update a Knight","attributes":"","tags":[]}]}