{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:29","snippets":[{"name":"tenure_report","title":"tenure_report","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\t\r\n\/\/Connect To Database\r\n$db = LocalDatabase::getReadable('master');\r\n$ktable='knight_directory';\r\n$ltable='lodge_directory';\r\n$knightArray = array();\r\n\r\n$todaysDate = getdate();\r\n$year = $todaysDate['year'];\r\n$month = formatDate($todaysDate['mon']);\r\n$day = formatDate($todaysDate['mday']);\r\n$query = 'SELECT k.NICKNAME AS NICKNAME, k.DATE_KNIGHTED AS DATE_KNIGHTED, k.RECORD_NUM AS RECORD_NUM, l.lodge_name AS lodgename FROM ' . $ktable . ' AS k, '.$ltable.' AS l WHERE k.RANK != 3 AND k.RANK != 4 AND k.DATE_WITHDREW = \"0000-00-00\" AND k.DATE_KNIGHTED != \"0000-00-00\" AND k.LODGE = l.lodge_num ORDER BY k.DATE_KNIGHTED, k.RECORD_NUM';\r\n$result = mysqli_query($db->connection, $query);\r\nif($result)  {\r\n\t$i = 0;\r\n\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t$knightyear = substr($row['DATE_KNIGHTED'], 0, 4);\r\n\t\t$knightmonth = substr($row['DATE_KNIGHTED'], 5, 2);\r\n\t\t$knightday = substr($row['DATE_KNIGHTED'], 8, 2);\r\n\t\t$years = $year - $knightyear;\r\n\t\t$months = $month - $knightmonth;\r\n\t\tif ($months <= 0) {\r\n\t\t\t$months += 12;\r\n\t\t\t$years--;\r\n\t\t}\r\n\t\tif ($months == 12) {\r\n\t\t\t$months -= 12;\r\n\t\t\t$years++;\r\n\t\t}\r\n\t\t$monthsGone = reinstated($db, $row['RECORD_NUM']);\r\n\t\tif ($monthsGone != 0) {\r\n\t\t\twhile ($monthsGone > 11) {\r\n\t\t\t\t$years--;\r\n\t\t\t\t$monthsGone -= 12;\r\n\t\t\t}\r\n\t\t\t$months -= $monthsGone;\r\n\t\t\tif ($months < 0) {\r\n\t\t\t\t$months = 12 + $months; \r\n\t\t\t\t$years--;\r\n\t\t\t}\r\n\t\t}\r\n\t\t$knightArray[$years][$i] = array(\"nickname\" => $row['NICKNAME'], \"years\" => $years, \"months\" => $months, \"lodgename\" => $row['lodgename']);\r\n\t\t$i++;\r\n\t}\r\n\tkrsort($knightArray);\r\n\t$arrayKeys = array_keys($knightArray);\r\n\t$ak = 0;\r\n\techo '<table>';\r\n\tforeach($knightArray as $yearGroup) {\r\n\t\techo '<tr><th colspan=\"4\"><center><b>'.$arrayKeys[$ak].'+<\/b> years of service<\/center><\/th><\/tr>\r\n\t\t<tr><th>Knight<\/th><th>Years<\/th><th>Months<\/th><th>Lodge<\/th><\/tr>';\r\n\t\tforeach($yearGroup as $knight) {\r\n\t\t\techo '<tr><td>'.$knight[\"nickname\"].'<\/td><td>'.$knight[\"years\"].'<\/td><td>'.$knight[\"months\"].'<\/td><td>'.$knight[\"lodgename\"].'<\/td><\/tr>';\r\n\t\t}\r\n\t\t$ak++;\r\n\t}\r\n\techo '<\/table>';\r\n}\r\n\r\nmysqli_close($db->connection);\r\n\r\nfunction formatDate($element) {\r\n\tif($element < 10) {\r\n\t\treturn '0' . $element;\r\n\t} else {\r\n\t\treturn $element;\r\n\t}\r\n}\r\n\r\nfunction reinstated($db, $record_num) {\r\n\t$query = 'SELECT * FROM reinstatement_corollary WHERE knight_num = '.$record_num;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\tif($result)  {\r\n\t\t$rrow = mysqli_fetch_array($result);\r\n\t\t$wyear = substr($rrow['date_withdrew'], 0, 4);\r\n\t\t$wmonth = substr($rrow['date_withdrew'], 5, 2);\r\n\t\t$wday = substr($rrow['date_withdrew'], 8, 2);\r\n\t\t$ryear = substr($rrow['date_reinstated'], 0, 4);\r\n\t\t$rmonth = substr($rrow['date_reinstated'], 5, 2);\r\n\t\t$rmonth = substr($rrow['date_reinstated'], 5, 2);\r\n\t\r\n\t\t$years = $ryear - $wyear;\r\n\t\t$months = $rmonth - $wmonth;\r\n\t\tif ($months <= 0) {\r\n\t\t\t$months += 12;\r\n\t\t\t$years--;\r\n\t\t}\r\n\t\tif ($months == 12) {\r\n\t\t\t$months -= 12;\r\n\t\t\t$years++;\r\n\t\t}\r\n\t\treturn $months + ($years * 12);\r\n\t} else {\r\n\t\treturn 0;\r\n\t}\r\n}","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP script to show Tenure Report","attributes":"","tags":[]}]}