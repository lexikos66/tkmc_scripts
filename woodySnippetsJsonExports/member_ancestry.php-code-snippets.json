{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:29","snippets":[{"name":"member_ancestry","title":"member_ancestry","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/includes\/form_functions.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\t\r\n\/\/Connect To Database\r\n$db = LocalDatabase::getReadable('master');\r\n$ktable='knight_directory';\r\n$ltable='lodge_directory';\r\n$lodgeName='';\r\n$ancestry = array();\r\n$ancestry_keys = array();\r\n$mentors = array();\r\n\r\nif(isset($_GET[\"lodgeNum\"])) {\r\n\t\/\/ Get the Lodge Name\r\n\t$lodgeNum = $_GET['lodgeNum'];\r\n\t$query = \"SELECT LODGE_NAME FROM \" . $ltable . \" WHERE LODGE_NUM = \" . $lodgeNum;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\tif($result) {\r\n  \t\t$row = mysqli_fetch_array($result);\r\n\t\t$lodgeName = $row['LODGE_NAME'];\r\n\t}\r\n\t\r\n\t\/\/ Get Member Info for desired Lodge\r\n\t$query = \"SELECT FNAME, LNAME, NICKNAME, RECORD_NUM, MENTOR, RANK FROM \" . $ktable . \" WHERE LODGE = \" . $lodgeNum;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t\/\/ Stuff entries in member array to pull out name\/nickname\r\n\t\tif($row['RANK'] !== 'Honorary') {\r\n\t\t\tif($row['RECORD_NUM'] != $row['MENTOR']) {\r\n\t\t\t\tif($row['RANK'] == 'Provisional') {\r\n\t\t\t\t\t$ancestry[$row['MENTOR']][$row['RECORD_NUM']] = $row['FNAME'] . ' ' . $row['LNAME'];\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$ancestry[$row['MENTOR']][$row['RECORD_NUM']] = $row['NICKNAME'];\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t$ancestry[0][$row['RECORD_NUM']] = $row['NICKNAME']; \/\/ account for Commanders of Lodge\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t\/\/ Get mentors names\r\n\t$ancestry_keys = array_keys($ancestry);\r\n\t$mentorsCsv = implode(\",\", $ancestry_keys);\r\n\t$query = \"SELECT RECORD_NUM, NICKNAME from \" . $ktable . \" WHERE RECORD_NUM IN (\".$mentorsCsv.\")\";\r\n\t$result = mysqli_query($db->connection, $query);\r\n\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t$mentors[$row['RECORD_NUM']] = $row['NICKNAME'];\r\n\t}\r\n\r\n\techo '<html>\r\n\t\t\t<head>\r\n            \t<style>\r\n                \ttable * { border: 2px !important; }\r\n                <\/style>\r\n\t\t\t\t<script type=\"text\/javascript\" src=\"https:\/\/www.google.com\/jsapi\"><\/script>\r\n\t\t\t\t<script type=\"text\/javascript\">\r\n\t\t\t\t\tgoogle.load(\"visualization\", \"1\", {packages:[\"orgchart\"]});\r\n\t\t\t\t\tgoogle.setOnLoadCallback(drawChart);\r\n\t\t\t\t\tfunction drawChart() {\r\n\t\t\t\t\t\tvar data = new google.visualization.DataTable();\r\n\t\t\t\t\t\tdata.addColumn(\"string\", \"Name\");\r\n\t\t\t\t\t\tdata.addColumn(\"string\", \"Mentor\");\r\n\t\t\t\t\t\tdata.addColumn(\"string\", \"ToolTip\");\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdata.addRows(['.getRowData($ancestry, $ancestry_keys, $mentors).']);\r\n\t\t\t\t\t\tvar chart = new google.visualization.OrgChart(document.getElementById(\"chart_div\"));\r\n\t\t\t\t\t\tchart.draw(data, {allowHtml:true});\r\n\t\t\t\t\t}\r\n\t\t\t\t<\/script>\r\n\t\t\t<\/head>\r\n\t\t\t<body>\r\n\t\t\t\t<div id=\"chart_div\"><\/div>\r\n\t\t\t<\/body>\r\n\t\t<\/html>';\r\n} else {\r\n\techo '<form action=\"http:\/\/member.templarknightsmc.com\/knights\/ancestry\" method=\"get\">';\r\n\tlodge_dropdown($db, $ltable);\r\n\techo '<\/p>';\r\n\techo '<p><input style=\"float:center; margin-right:12px;\" type=\"submit\" value=\"Submit!\" id=\"submit-button\" class=\"button\"><\/p>';\r\n\techo '<\/form>';\r\n}\r\n\r\nmysqli_close($db->connection);\r\n\r\nfunction getRowData($ancestry, $ancestry_keys, $mentors) {\r\n\t$retval = '';\r\n\t\/\/ Put Smiles in here, because he moved from Lodge to Lodge\r\n\t$retval .= '[\"Smiles\",\"Mayhem\",'.'\"\"],';\r\n\tforeach($ancestry_keys as $mentor) {\r\n\t\t$provisionals = $ancestry[$mentor];\r\n\t\tforeach($provisionals as $provisional) {\r\n\t\t\tif($mentor == 0) {\r\n\t\t\t\t$retval .= '[\"'.$provisional.'\",\"Founders\",'.'\"\"],';\r\n\t\t\t} else {\r\n\t\t\t\t$retval .= '[\"'.$provisional.'\",\"'.$mentors[$mentor].'\",'.'\"\"],';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn $retval;\r\n}","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP Script to show member ancestry","attributes":"","tags":[]}]}