{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:28","snippets":[{"name":"attendance_entry","title":"attendance_entry","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\t\r\n$knighttable = 'knight_directory';\r\n$ltable = 'lodge_directory';\r\n$requiredId = 0;\r\n$lodgeNum = 0;\r\n$lodgeName = '';\r\n$lodgeCode = '';\r\n$emdbExt = 'feru';\r\n$emdbName = 'ss_dbname501';\r\n\r\n$mdb = LocalDatabase::getReadable('master');\r\n\r\n\r\n\/\/ Set council flag if grand_council or lodge_council && get lodge number and lodge name\r\n$current_user = wp_get_current_user();\r\nif (in_array(\"grand_council\", $current_user->roles) || in_array(\"lodge_council\")) { $isCouncil = true; }\r\n$roles = implode('\",\"',$current_user->roles);\r\n$query = 'SELECT * FROM ' . $ltable . ' WHERE LODGE_CODE in (\"'. $roles .'\")';\r\n$result = mysqli_query($mdb->connection, $query);\r\nif($result) {\r\n\twhile($row = mysqli_fetch_array($result)){\r\n\t\t$lodgeCode = $row['LODGE_CODE'];\r\n\t\t$lodgeName = $row['LODGE_NAME'];\r\n\t\t$lodgeNum = $row['LODGE_NUM'];\r\n\t}\r\n}\r\n\r\necho '<form action=\"http:\/\/templarknightsmc.com\/scripts\/attendance_action.php\" method=\"post\">';\r\n$todaysDate = getdate();\r\n$year = $todaysDate['year'];\r\nif ($year <= 2018) {\r\n\t$emdbExt = \"hiqx\";\r\n\t$emdbName = \"wor7320\";\r\n}\r\n$emdb = LocalDatabase::getReadable($emdbName);\r\n$month = formatDate($todaysDate['mon']);\r\n$day = formatDate($todaysDate['mday']);\r\n\r\n\/\/ Get Categroy IDs\r\n$query = \"SELECT * FROM wp_\".$emdbExt.\"_terms WHERE slug like '%\".$lodgeCode.\"%'\";\r\n$result = mysqli_query($emdb->connection, $query);\r\nwhile ($row = mysqli_fetch_array($result)) {\r\n\tif (strpos($row[\"slug\"], \"required\")) { \r\n\t\t$requiredId = $row[\"term_id\"];\r\n\t} else if (strpos($row[\"slug\"], \"events\")) {\r\n\t\t$eventId = $row[\"term_id\"];\r\n\t}\r\n}\r\n\r\necho '<p>Select Event:&nbsp;&nbsp;';\r\n$query = 'SELECT wp_'.$emdbExt.'_em_events.event_id AS event_id, wp_'.$emdbExt.'_em_events.post_id AS post_id, wp_'.$emdbExt.'_em_events.event_name AS event_name, wp_'.$emdbExt.'_em_events.event_start_date AS start_date FROM wp_'.$emdbExt.'_em_events, wp_'.$emdbExt.'_term_relationships WHERE wp_'.$emdbExt.'_term_relationships.term_taxonomy_id = '.$requiredId.' AND wp_'.$emdbExt.'_em_events.event_start_date > \"' . $year . '-01-01\" AND wp_'.$emdbExt.'_em_events.event_start_date <= \"' . $year . '-' . $month . '-' . $day . '\" AND wp_'.$emdbExt.'_em_events.event_spaces = 0 AND wp_'.$emdbExt.'_em_events.post_id =  wp_'.$emdbExt.'_term_relationships.object_id AND wp_'.$emdbExt.'_em_events.recurrence_id != \"\" ORDER BY wp_'.$emdbExt.'_em_events.event_start_date'; \r\n$result = mysqli_query($emdb->connection, $query);\r\nif($result) {\r\n\techo '<select name=\"eventId\">';\r\n\twhile($row = mysqli_fetch_array($result)) {\r\n\t\techo '<option value=\"' . $row['event_id'] . '\">' . $row['event_name'] . ':' . $row['start_date'] . '<\/option>';\r\n\t}\r\n\techo '<\/select><\/p>';\r\n}\r\nmysqli_close($emdb->connection);\r\n\r\necho '<br><b>Attendees:<\/b>';\r\n$query = 'SELECT * FROM ' . $knighttable . ' WHERE LODGE = '.$lodgeNum.' ORDER BY NICKNAME';\r\n$result = mysqli_query($mdb->connection, $query);\r\nif($result) {\r\n\techo '<input type=\"checkbox\" name=\"mtgParticipants[]\" value=\"NONE\" style=\"display:none;\" \/>';\r\n\techo '<table border=\"0\"><tr>';\r\n\t$i=1;\r\n\twhile($row = mysqli_fetch_array($result)){\r\n\t\tif($row['DATE_WITHDREW'] == '0000-00-00') {\r\n\t\t\tif($row['NICKNAME'] == \"\") {\r\n\t\t\t\techo '<td><input type=\"checkbox\" name=\"mtgParticipants[]\" value=\"' . $row['RECORD_NUM'] . '\" \/> ' . $row['FNAME'] . ' ' . $row['LNAME'] . '&nbsp;&nbsp;<\/td>';\r\n\t\t\t} else {\r\n\t\t\techo '<td><input type=\"checkbox\" name=\"mtgParticipants[]\" value=\"' . $row['RECORD_NUM'] . '\" \/> ' . $row['NICKNAME'] . '&nbsp;&nbsp;<\/td>';\r\n\t\t\t}\r\n\t\t\tif($i\/5 == 1) {\r\n\t\t\t\techo '<\/tr><tr>';\r\n\t\t\t\t$i=0;\r\n\t\t\t}\r\n\t\t\t$i++;\r\n\t\t}\r\n\t}\r\n\techo '<\/table><\/font><br>';\r\n}\r\necho '<input type=\"hidden\" name=\"lodgeNum\" value=\"'.$lodgeNum.'\" \/>';\r\necho '<p><input type=\"submit\" value=\"Record Attendance\"><\/p>';\r\n\r\nmysqli_close($mdb->connection);\r\n\r\n\t\r\nfunction formatDate($element) {\r\n\tif($element < 10) {\r\n\t\treturn '0' . $element;\r\n\t} else {\r\n\t\treturn $element;\r\n\t}\r\n}","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP script to enter attendance records.","attributes":"","tags":[]}]}