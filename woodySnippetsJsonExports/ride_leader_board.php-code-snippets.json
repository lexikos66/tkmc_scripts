{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:30","snippets":[{"name":"ride_leader_board","title":"ride_leader_board","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\t\r\n\/\/Connect To Database\r\n$db = LocalDatabase::getReadable('master');\r\n$lodgetable='lodge_directory';\r\n$ktable='knight_directory';\r\n$rtable='ride_directory';\r\n$ctable='ride_corollary';\r\n$miles_array=array();\r\n$lodgeName='';\r\n$lodgeNum ='';\r\n$mileage = 0;\r\n$array_num = 0;\r\n$query = '';\r\n\r\n$current_user = wp_get_current_user();\r\n$roles = implode('\",\"',$current_user->roles);\r\n$query = 'SELECT * FROM ' . $lodgetable . ' WHERE LODGE_CODE in (\"'. $roles .'\")';\r\n$result = mysqli_query($db->connection, $query);\r\nif($result) {\r\n    while($row = mysqli_fetch_array($result)){\r\n        $lodgeName = $row['LODGE_NAME'];\r\n        $lodgeNum = $row['LODGE_NUM'];\r\n    }\r\n}\r\n\r\n$query = 'SELECT * FROM ' . $ktable . ' WHERE LODGE = '.$lodgeNum.' && DATE_WITHDREW=0000-00-00';\r\n$result = mysqli_query($db->connection, $query);\r\n\r\nif($result) {\r\n\twhile($row = mysqli_fetch_array($result)) {\r\n  \t\t$query = 'SELECT k.NICKNAME, k.FNAME, m.MILES FROM knight_directory AS k INNER JOIN ride_corollary AS c ON k.RECORD_NUM=c.KNIGHT_NUM JOIN ride_directory AS m on c.RIDE_NUM=m.RIDE_NUM WHERE k.RECORD_NUM = ' . $row['RECORD_NUM'];\r\n\t\t$inner_result = mysqli_query($db->connection, $query);\r\n  \t\tif ($inner_result) {\r\n  \t\t\t$mileage = 0;\r\n\t\t\twhile($inner_row = mysqli_fetch_array($inner_result)){\r\n    \t\t\t$mileage = $mileage + $inner_row['MILES'];\r\n  \t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif ($row['NICKNAME'] == \"\") {\r\n\t\t\t$miles_array[$row['FNAME'].'_'.$row['RECORD_NUM']] = $mileage;\r\n\t\t} else {\r\n\t\t\t$miles_array[$row['NICKNAME'].'_'.$row['RECORD_NUM']] = $mileage;\r\n\t\t}\r\n\t\t$array_num += 1;\r\n\t}\r\n}\r\nprint_leaders($miles_array, $lodgeName);\r\nmysqli_close($db->connection);\r\n\r\nfunction print_leaders($array, $lodgeName) {\r\n$i = 0;\r\necho '<table><tr><th colspan=2 style=\"text-align:center\">'.$lodgeName.' Leaders<\/th><\/tr>';\r\narsort($array);\r\nforeach ($array as $key => $value) {\t\r\n\t\tif ($i < 10) {\r\n                     echo '<tr><td style=\"text-align:center\">' . substr($key, 0, strpos($key, '_')) . '<\/td><td> ' . $value .   '<\/td><\/tr>';\r\n                     $i++;\r\n                } else { break; }\r\n\t}\r\necho '<\/table>';\r\n}","location":"header","type":"php","filters":"","changed_filters":"0","scope":"shortcode","description":"PHP Script to generate the Ride Leader Board by Lodge","attributes":"","tags":[]}]}