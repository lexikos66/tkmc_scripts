{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:29","snippets":[{"name":"patch_status","title":"patch_status","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/includes\/form_functions.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\r\n\/\/Connect To Database\r\n$db = LocalDatabase::getReadable('master');\r\n$ktable = 'knight_directory';\r\n$ltable = 'lodge_directory';\r\n$ptable='provisional_progress';\r\n$lodgeNum = '';\r\n\r\necho '<style type=\"text\/css\">.patchstatus input{background: aliceblue;} .patchstatus textarea{background: aliceblue;}<\/style>';\r\necho '<div class=\"patchstatus\">';\r\n\/\/ If provisional_ID is not given, then show all active provisionals\r\nif (!isset($_GET['provisional_id'])) {\r\n\r\n\tif (isset($_GET['updated'])) {\r\n\t\techo '<p style=\"font-weight:bold;font-size:16px;\">The Provisional record has been updated successfully.<\/p>';\r\n\t}\r\n\r\n\t$query = 'SELECT p.*, k.FNAME, k.LNAME, k.NICKNAME, l.LODGE_NAME, l.EMAIL_ADDR, l.COUNTRY FROM '.$ptable.' as p JOIN '.$ktable.' as k ON k.RECORD_NUM = p.knight_num JOIN '.$ltable.' as l ON k.LODGE = l.LODGE_NUM WHERE (p.tr_request_date != \"0000-00-00\" AND p.tr_shipped_date = \"0000-00-00\") OR (p.request_date != \"0000-00-00\" AND p.shipped_date = \"0000-00-00\") ORDER BY l.LODGE_NAME, k.FNAME';\r\n\t\r\n\t\r\n\t$result = mysqli_query($db->connection, $query);\r\n\tif ($result) {\r\n\t\twhile($row = mysqli_fetch_array($result)){\r\n\t\t\t$tr_approved = false;\r\n\t\t\t$app_fee_paid = false;\r\n\t\t\t$patches_fee_paid = false;\r\n\t\t\t$tr_can_order = false;\r\n\t\t\t$tr_ordered = false;\r\n\t\t\t$tr_shipped = false;\r\n\t\t\t$patches_can_order = false;\r\n\t\t\t$patches_ordered = false;\r\n\t\t\t$patches_shipped = false;\r\n\t\t\t$status_str = '';\r\n\r\n\t\t\techo '<p><a href=\"http:\/\/member.templarknightsmc.com\/provisional-progress\/patch-status?provisional_id='.$row['knight_num'].'\">'.$row['FNAME'].' '.$row['LNAME'].'<\/a> ['.$row['LODGE_NAME'].'] - ';\r\n\t\t\tif ($row['t1_approved'] && $row['t2_approved'] && $row['t3_approved']) { $tr_approved = true; }\r\n\t\t\tif ($row['app_fee_date'] == \"0000-00-00\") { $status_str .= 'App Fee Needs Paid\/Recorded | '; } else { $app_fee_paid = true; }\r\n\t\t\tif ($row['COUNTRY'] != 'Sweden') { \r\n\t\t\t\tif ($row['patches_paid_date'] == \"0000-00-00\") { $status_str .= 'Patches Fee Needs Paid\/Recorded | '; } else { $patches_fee_paid = true; }\r\n\t\t\t} else { $patches_fee_paid = true; }\r\n\t\t\tif (!$tr_approved) { $status_str .= 'Top Rocker Needs Approved | '; }\r\n\t\t\tif ($tr_approved && $app_fee_paid && $patches_fee_paid) { $tr_can_order = true; }\r\n\t\t\tif ($row['tr_ordered_date'] != \"0000-00-00\") { $tr_ordered = true; }\r\n\t\t\tif ($tr_can_order && !$tr_ordered) { $status_str .= 'Top Rocker Needs Ordered | '; }\r\n\t\t\tif ($row['tr_shipped_date'] != \"0000-00-00\") { $tr_shipped = true; }\r\n\t\t\tif ($tr_ordered && !$tr_shipped) { $status_str .= 'Top Rocker Needs Shipped | '; }\r\n\t\t\tif ($row['tr_shipped_date'] != \"0000-00-00\") { $tr_shipped = true; }\r\n\t\t\tif ($tr_shipped && !$row['t5_approved']) { $status_str .= 'Center Patch Needs Approved | '; }\r\n\t\t\tif ($row['ordered_date'] != \"0000-00-00\") { $patches_ordered = true; }\r\n\t\t\tif ($row['t5_approved'] && $tr_shipped) { $patches_can_order = true; }\r\n\t\t\tif ($patches_can_order && $row['request_date'] != \"0000-00-00\" && !$patches_ordered) { $status_str .= 'Center Patch Needs Ordered | '; }\r\n\t\t\tif ($row['shipped_date'] != \"0000-00-00\") { $patches_shipped = true; }\r\n\t\t\tif ($patches_ordered && !$patches_shipped) { $status_str .= 'Center Patch Needs Shipped | '; }\t\t\t\r\n\t\t\techo substr($status_str, 0, strlen($status_str) - 2);\r\n\t\t\techo '<\/p>';\r\n\t\t}\r\n\t}\r\n} else {\r\n\techo '<p><a href=\"http:\/\/member.templarknightsmc.com\/provisional-progress\/patch-status\">Back<\/a><\/p>';\r\n\techo '<table><tr><td>Task 1: Find an event the Lodge could help promote<\/td><td>Task 4: Patch Symbolism<\/td><\/tr>';\r\n\techo '<tr><td>Task 2: Volunteer time at a current event<\/td><td>Task 5: Growth of the Order<\/td><\/tr>';\r\n\techo '<tr><td>Task 3: Ride 400 miles with Mentor<\/td><td><\/td><\/tr><\/table>';\r\n\techo '<form action=\"http:\/\/templarknightsmc.com\/scripts\/patch_status_action.php\" method=\"post\">';\r\n\t$query = 'SELECT kd.FNAME, kd.LNAME, kd.NICKNAME, ld.LODGE_NAME, ld.EMAIL_ADDR, ld.COUNTRY FROM '.$ktable.' as kd JOIN '.$ltable.' as ld ON kd.LODGE = ld.LODGE_NUM WHERE kd.RECORD_NUM = ' . $_GET[\"provisional_id\"];\r\n\t$result = mysqli_query($db->connection, $query);\r\n\tif($result) {\r\n\t\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t\techo 'PROVISIONAL: ' . $row['FNAME'] . \" '\" . $row['NICKNAME'] . \"' \" . $row['LNAME'] . '<br>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"first_name\" value=\"' . $row['FNAME'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"last_name\" value=\"' . $row['LNAME'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"knight_name\" value=\"' . $row['FNAME'] . \" '\" . $row['NICKNAME'] . \"' \" . $row['LNAME'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"knight_num\" value=\"' . $_GET['provisional_id'] . '\"><\/div>';\r\n\t\t\techo 'LODGE: ' . $row['LODGE_NAME'];\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"lodge_name\" value=\"' . $row['LODGE_NAME'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"lodge_email\" value=\"' . $row['EMAIL_ADDR'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"country\" value=\"' . $row['COUNTRY'] . '\"><\/div>';\r\n\t\t\techo '<div style=\"display:none;\"><input type=\"hidden\" name=\"nickname\" value=\"' . $row['NICKNAME'] . '\"><\/div>';\r\n\r\n\t\t\techo '<table><tr><th><\/th><th>Approved<\/th><th>Completion Date<br>(yyyy-mm-dd)<\/th><th>Task Description<\/th><\/tr>';\r\n\r\n\t\t\t$query = 'SELECT * FROM '.$ptable.' WHERE knight_num = ' . $_GET['provisional_id'];\r\n\t\t\t$tresult = mysqli_query($db->connection, $query);\r\n\t\t\tif ($tresult) {\r\n\t\t\t\t$progress = mysqli_fetch_array($tresult);\r\n\t\t\t\t\/\/ Show stuff for Task 1\r\n\t\t\t\tif ($progress['t1_approved']) {\r\n\t\t\t\t\techo '<tr><td>Task #1<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task1\" checked\/><\/td><td>' . $progress['t1_date'] . '<\/td><td>' . $progress['t1_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<tr><td>Task #1<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task1\" \/><\/td><td>' . $progress['t1_date'] . '<\/td><td>' . $progress['t1_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t}\r\n\t\t\t\t\/\/ Show stuff for Task 2\r\n\t\t\t\tif ($progress['t2_approved']) {\r\n\t\t\t\t\techo '<tr><td>Task #2<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task2\" checked\/><\/td><td>' . $progress['t2_date'] . '<\/td><td>' . $progress['t2_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<tr><td>Task #2<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task2\" \/><\/td><td>' . $progress['t2_date'] . '<\/td><td>' . $progress['t2_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t}\r\n\t\t\t\t\/\/ Show stuff for Task 3\r\n\t\t\t\tif ($progress['t3_approved']) {\r\n\t\t\t\t\techo '<tr><td>Task #3<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task3\" checked\/><\/td><td>' . $progress['t3_date'] . '<\/td><td>' . $progress['t3_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<tr><td>Task #3<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task3\" \/><\/td><td>' . $progress['t3_date'] . '<\/td><td>' . $progress['t3_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t}\r\n\t\t\t\t\/\/ Show stuff for task 4\r\n\t\t\t\techo '<tr><td>Task #4<\/td><td><input type=\"checkbox\" name=\"tasksNotApproved[]\" value=\"task4\" checked disabled\/><\/td><td>' . $progress['t4_date'] . '<\/td><td>' . $progress['t4_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t\/\/ Show stuff for Task 5\r\n\t\t\t\tif ($progress['t5_approved']) {\r\n\t\t\t\t\techo '<tr><td>Task #5<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task5\" checked\/><\/td><td>' . $progress['t5_date'] . '<\/td><td>' . $progress['t5_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<tr><td>Task #5<\/td><td><input type=\"checkbox\" name=\"tasksApproved[]\" value=\"task5\" \/><\/td><td>' . $progress['t5_date'] . '<\/td><td>' . $progress['t5_detail'] . '<\/td><\/tr>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<\/table><table>';\r\n\t\t\t\techo '<tr><td>Knighting Date (yyyy-mm-dd):<\/td><td>' . $progress['knighting_date'] . '<\/td><\/tr>';\r\n\t\t\t\techo '<tr><td>Patches Needed by (yyyy-mm-dd):<\/td><td>' . $progress['needed_by'] . '<\/td><\/tr>';\r\n\t\t\t\techo '<tr><td>Nickname:<\/td><td>' . $row['NICKNAME'] . '<\/td><\/tr>';\r\n\t\t\t\techo '<tr><td>Patches Needed:<\/td><td>';\r\n\t\t\t\tif ($progress['top_rocker']) {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"tr_dontsend[]\" value=\"top_rocker\" checked disabled\/><font color=\"gray\">Top Rocker Requested on '.$progress['tr_request_date'].'<\/font>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"top_rocker\" disabled\/><font color=\"gray\">Top Rocker<\/font>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<br>';\r\n\t\t\t\tif ($progress['bottom_rocker']) {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"bottom_rocker\" checked disabled\/><font color=\"gray\">Bottom Rocker Requested on '. $progress['request_date'] . '<\/font>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"bottom_rocker\" disabled\/><font color=\"gray\">Bottom Rocker<\/font>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<br>';\r\n\t\t\t\tif ($progress['center_patch']) {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"center_patch\" checked disabled\/><font color=\"gray\">Center Club Patch Requested on '. $progress['request_date'] . '<\/font>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"center_patch\" disabled\/><font color=\"gray\">Center Club Patch<\/font>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<br>';\r\n\t\t\t\tif ($progress['rank_patch']) {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"rank_patch\" checked disabled\/><font color=\"gray\">Rank Patch Requested on '. $progress['request_date'] . '<\/font>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"rank_patch\" disabled\/><font color=\"gray\">Rank Patch<\/font>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<br>';\r\n\t\t\t\tif ($progress['nickname_patch']) {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"nickname_patch\" checked disabled\/><font color=\"gray\">Nickname Patch Requested on '. $progress['request_date'] . '<\/font>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<input type=\"checkbox\" name=\"patchesNeeded[]\" value=\"nickname_patch\" disabled\/><font color=\"gray\">Nickname Patch<\/font>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<br>';\r\n\t\t\t\techo '<\/td><\/tr>';\r\n\t\t\t\techo '<\/table><\/div>';\r\n\t\t\t\techo '<tr><td><input type=\"submit\" name=\"patch_status\" value=\"Update Record\" \/><\/td>';\r\n\t\t\t\techo '<br><hr>';\r\n\t\t\t\techo '<div class=\"patchstatus\"><p style=\"text-align:center;font-size:20px\">--- Grand Master Sergeant Only ---- Grand Master Sergeant Only ----<\/p>';\r\n\t\t\t\techo '<hr><br><table>';\r\n\t\t\t\t\/\/$current_user = wp_get_current_user();\r\n\t\t\t\t\/**\r\n\t\t\t\t * @example Safe usage: $current_user = wp_get_current_user();\r\n\t\t\t\t * if ( !($current_user instanceof WP_User) )\r\n\t\t\t\t *     return;\r\n\t\t\t\t *\/\r\n\t\t\t\t\/\/$approved_users = 'Hollywood Pepperman reaper';\r\n\t\t\t\t\/\/$is_approved = strpos($approved_users, $current_user->user_login);\r\n\t\t\t\techo '<tr><td>Application Fee Paid (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"app_fee_date\" value=\"'.$progress['app_fee_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\r\n\t\t\t\tif ($row['COUNTRY'] == 'Sweden') {\r\n\t\t\t\t\techo '<tr><td>Top Rocker Fee Paid (yyyy-mm-dd):<\/td><td>*This will be set automagically to the Application Fee Paid date.*<\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Top Rocker Ordered Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"tr_ordered_date\" value=\"'.$progress['tr_ordered_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Other Patches Fee Paid (yyyy-mm-dd):<\/td><td>*This will be set automagically to the Top Rocker Ordered date.*<\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Other Patches Ordered Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"ordered_date\" value=\"'.$progress['ordered_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\techo '<tr><td>Patches Fee Paid (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"patches_paid_date\" value=\"'.$progress['patches_paid_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Top Rocker Ordered Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"tr_ordered_date\" value=\"'.$progress['tr_ordered_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Top Rocker Shipped Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"tr_shipped_date\" value=\"'.$progress['tr_shipped_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Other Patches Ordered Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"ordered_date\" value=\"'.$progress['ordered_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t\techo '<tr><td>Other Patches Shipped Date (yyyy-mm-dd):<\/td><td><input type=\"text\" name=\"shipped_date\" value=\"'.$progress['shipped_date'].'\" \/><\/td><\/tr>';\r\n\t\t\t\t}\r\n\t\t\t\techo '<tr><td>Notes:<\/td><td><textarea name=\"notes\" rows=\"4\" cols=\"45\">' . $progress[notes] . '<\/textarea><\/td><\/tr>';\r\n\t\t\t\techo '<\/table><\/div>';\r\n\t\t\t\techo '<tr><td><input type=\"submit\" name=\"patch_status\" value=\"Update Record\" \/><\/td>';\r\n\r\n\t\t\t} else {\r\n\t\t\t\techo '<\/table><\/div>';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\techo '<\/form>';\r\n}\r\n\r\nmysqli_close($db->connection);\r\n\t\r\nfunction formatDate($element) {\r\n\tif($element < 10) {\r\n\t\treturn '0' . $element;\r\n\t} else {\r\n\t\treturn $element;\r\n\t}\r\n}\r\n\r\nfunction getState($state_num, $db) {\r\n\t$query = 'SELECT STATE_NAME FROM state_directory WHERE STATE_NUM = '.$state_num;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\t$row = mysqli_fetch_array($result);\r\n\treturn $row['STATE_NAME'];\r\n}\r\n\r\nfunction getCountry($country_num, $db) {\r\n\t$query = 'SELECT COUNTRY_NAME FROM country_directory WHERE COUNTRY_NUM = '.$country_num;\r\n\t$result = mysqli_query($db->connection, $query);\r\n\t$row = mysqli_fetch_array($result);\r\n\treturn $row['COUNTRY_NAME'];\r\n}","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP Script to update the status of Patch Requests.","attributes":"","tags":[]}]}