{"generator":"PHP Code Snippets v2.3.1","date_created":"2020-09-29 22:28","snippets":[{"name":"attendance_report","title":"attendance_report","content":"if (!defined('SCRIPTS_DIR')) {\r\n\tdefine('SCRIPTS_DIR', '\/home1\/templark\/scripts');\r\n}\r\nrequire_once(SCRIPTS_DIR.'\/includes\/defines.inc');\r\nrequire_once(SCRIPTS_DIR.'\/classes\/Database.class');\r\n\t\r\n\/\/Connect To Database\r\n$requiredId = 0;\r\n$eventId = 0;\r\n$lodgeNum = 0;\r\n$lodgeName = \"\";\r\n$lodgeCode = \"\";\r\n$emdbName = 'ss_dbname501';\r\n$emdbExt = 'feru';\r\n$ktable = 'knight_directory';\r\n$ctable = 'attendance_corollary';\r\n$ltable = 'lodge_directory';\r\n$knightArray = \"\";\r\n$isCouncil = false;\r\n\r\n$mdb = LocalDatabase::getReadable('master');\r\n\r\n\r\n\/\/ Set council flag if grand_council or lodge_council && get lodge number and lodge name\r\n$current_user = wp_get_current_user();\r\nif (in_array(\"grand_council\", $current_user->roles) || in_array(\"lodge_council\")) { $isCouncil = true; }\r\n$roles = implode('\",\"',$current_user->roles);\r\n$query = 'SELECT * FROM ' . $ltable . ' WHERE LODGE_CODE in (\"'. $roles .'\")';\r\n$result = mysqli_query($mdb->connection, $query);\r\nif($result) {\r\n\twhile($row = mysqli_fetch_array($result)){\r\n\t\t$lodgeCode = $row['LODGE_CODE'];\r\n\t\t$lodgeName = $row['LODGE_NAME'];\r\n\t\t$lodgeNum = $row['LODGE_NUM'];\r\n\t}\r\n}\r\n\r\n\r\nif(isset($_GET[\"mtgYear\"])) {\r\n\t$mtgYear = $_GET[\"mtgYear\"];\r\n\t$nextYear = $mtgYear + 1;\r\n\t$todaysDate = getdate();\r\n\t$year = $todaysDate['year'];\r\n\t$month = formatDate($todaysDate['mon']);\r\n\t$day = formatDate($todaysDate['mday']);\r\n\tif($mtgYear != $year) {\r\n\t\t$year = $mtgYear;\r\n\t\t$month = \"12\";\r\n\t\t$day = \"31\";\r\n\t}\r\n\r\n\tif ($mtgYear <= 2018) {\r\n\t\t$emdbExt = \"hiqx\";\r\n\t\t$emdbName = \"wor7320\";\r\n\t}\r\n\r\n\t$emdb = LocalDatabase::getReadable($emdbName);\r\n\r\n\r\n\t\/\/ Get Categroy IDs\r\n\t$query = \"SELECT * FROM wp_\".$emdbExt.\"_terms WHERE slug like '%\".$lodgeCode.\"%'\";\r\n\t$result = mysqli_query($emdb->connection, $query);\r\n\twhile ($row = mysqli_fetch_array($result)) {\r\n\t\tif (strpos($row[\"slug\"], \"required\")) { \r\n\t\t\t$requiredId = $row[\"term_id\"];\r\n\t\t} else if (strpos($row[\"slug\"], \"events\")) {\r\n\t\t\t$eventId = $row[\"term_id\"];\r\n\t\t}\r\n\t}\r\n\r\n\techo '<a href=\"http:\/\/member.templarknightsmc.com\/lodge\/attendance-report\">Back<\/a>';\r\n\t\/\/echo '<div style=\"height:709px;width:820px;overflow-x:hidden;overflow-y:scroll;\">';\r\n\techo '<style type=\"text\/css\">\r\n\t\ttable\r\n\t\t{\r\n\r\n\t\t}\r\n\t\ttable,th,td\r\n\t\t{\r\n\t\tborder:1px solid white;\r\n\t\t}\r\n\t\tth\r\n\t\t{\r\n\t\ttext-align:center;\r\n\t\tpadding:5px;\r\n\t\tbackground-color:lightgray;\r\n\t\tcolor:black;\r\n\t\tfont-size:16px;\r\n\t\t}\r\n\t\ttd\r\n\t\t{\r\n\t\tcolor:black;\r\n\t\tpadding:3px;\r\n\t\tfont-size:14px;\r\n\t\t}\r\n        tr:nth-child(even) {background: #B0E0E6}\r\n        tr:nth-child(odd) {background: #FFFFFF}\r\n\t\t<\/style>';\r\n\techo '<table><tr><th>Name<\/th><th>Attendance<\/th><th>Events Missed<\/th><\/tr>';\r\n\t$query = \"SELECT * FROM \" . $ktable . \" WHERE LODGE = \".$lodgeNum.\" AND DATE_JOINED < '\" . $nextYear . \"-01-01' ORDER BY RECORD_NUM\";\r\n\t$result = mysqli_query($mdb->connection, $query);\r\n\tif($result)  {\r\n\t\t$i = 0;\r\n\t\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t\t$eventArray = \"\";\r\n\t\t\tif($row['DATE_WITHDREW'] == '0000-00-00' && $row['RANK'] != \"Honorary\") {\r\n\t\t\t\tif($row['NICKNAME'] == \"\") {\r\n\t\t\t\t\t$knightArray[$i]['name'] = $row['FNAME'] . ' ' . $row['LNAME'];\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\t$knightArray[$i]['name'] = $row['NICKNAME'];\r\n\t\t\t\t}\r\n\t\t\t\t$knightArray[$i]['id'] = $row['RECORD_NUM'];\r\n\t\t\t\t$knightArray[$i]['join'] = $row['DATE_JOINED'];\r\n\t\t\t\t$mquery = 'SELECT * FROM ' . $ctable . ' WHERE knight_num = ' . $row['RECORD_NUM'];\r\n\t\t\t\t$mresult = mysqli_query($mdb->connection, $mquery);\r\n\t\t\t\tif($mresult) {\r\n\t\t\t\t\twhile($mrow = mysqli_fetch_array($mresult)) {\r\n\t\t\t\t\t\t$eventArray[$mrow['event_id']] = $mrow['event_id'];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif($eventArray == \"\") {\r\n\t\t\t\t\t$knightArray[$i]['events'] = \"\";\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$knightArray[$i]['events'] = implode(\",\",$eventArray);\r\n\t\t\t\t}\r\n\t\t\t\t$i++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tmysqli_close($mdb->connection);\r\n\tforeach($knightArray as $knight) {\r\n\t\t\r\n\t\t$query = 'SELECT wp_'.$emdbExt.'_em_events.event_id AS event_id, wp_'.$emdbExt.'_em_events.event_name AS event_name,\r\n\t\t\twp_'.$emdbExt.'_em_events.event_start_date AS start_date FROM wp_'.$emdbExt.'_em_events, wp_'.$emdbExt.'_term_relationships\r\n\t\t\tWHERE wp_'.$emdbExt.'_term_relationships.term_taxonomy_id in ('.$requiredId.','.$eventId.') AND wp_'.$emdbExt.'_em_events.event_start_date > \"' . $knight['join'] . \r\n\t\t\t'\" AND wp_'.$emdbExt.'_em_events.event_start_date > \"' . $mtgYear . '-01-01\" AND wp_'.$emdbExt.'_em_events.event_start_date <= \"' . $year . '-' . $month . '-' . $day . \r\n\t\t\t'\" AND wp_'.$emdbExt.'_em_events.post_id = wp_'.$emdbExt.'_term_relationships.object_id AND wp_'.$emdbExt.'_em_events.recurrence_id != \"\" ORDER BY wp_'.$emdbExt.'_em_events.event_start_date'; \r\n\t\t$result = mysqli_query($emdb->connection, $query);\r\n\t\t$eventsAttended = 0;\r\n\t\t$totalEvents = 0;\r\n\t\t$missedEvents = \"\";\r\n\t\techo '<tr><td>' . $knight['name'] . '<\/td>';\r\n\t\tif($result) {\r\n\t\t\t$eventArray = explode(\",\", $knight['events']);\r\n\t\t\twhile($row = mysqli_fetch_array($result)) {\r\n\t\t\t\t$eventFound = 0;\r\n\t\t\t\tforeach($eventArray as $event) {\r\n\t\t\t\t\tif($row['event_id'] == $event) {\r\n\t\t\t\t\t\t$eventsAttended++;\r\n\t\t\t\t\t\t$eventFound = 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif($eventFound == 0) {\r\n\t\t\t\t\t$missedEvents[$row['event_id']] = $row['event_name'] . ':' . $row['start_date'];\r\n\t\t\t\t}\r\n\t\t\t\t$totalEvents++;\r\n\t\t\t}\r\n\t\t\tif($totalEvents == 0) {\r\n\t\t\t\techo '<td>100%<\/td>';\r\n\t\t\t} else {\r\n\t\t\t\techo '<td>' . number_format((($eventsAttended \/ $totalEvents) * 100)) . '%<\/td>';\r\n\t\t\t}\r\n\t\t\tif($missedEvents == \"\") {\r\n\t\t\t\techo '<td><\/td>';\r\n\t\t\t} else {\r\n\t\t\t\techo '<td>' . implode(\"<br>\", $missedEvents) . '<\/td>';\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\techo '<td>100%<\/td><td><\/td><\/tr>';\r\n\t\t}\r\n\t}\r\n\techo '<\/table>';\r\n\tmysqli_close($emdb->connection);\r\n} else {\r\n\t  echo '<form action=\"http:\/\/member.templarknightsmc.com\/lodge\/attendance-report\" method=\"get\">';\r\n\t  $todaysDate = getDate();\r\n\t  $numYears = $todaysDate['year'] - 2010;\r\n\t  echo '<p>Select Year:&nbsp;&nbsp;';\r\n\t  echo '<select name=\"mtgYear\">';\r\n\t  for($i = $numYears; $i > 0; $i--) {\r\n\t\techo '<option value=\"' . ($todaysDate['year'] - $i) . '\">' . ($todaysDate['year'] - $i) . '<\/option>';\r\n\t  }\r\n\t  echo '<option selected=\"yes\" value=\"' . $todaysDate['year'] . '\">' . $todaysDate['year'] . '<\/option>';\r\n\t  echo '<\/select><\/p>';\r\n\t  echo '<p><input type=\"submit\" value=\"Generate Report\"><\/p>';\r\n      echo '<\/form>';\r\n  }\r\n  \r\nfunction formatDate($element) {\r\n\tif($element < 10) {\r\n\t\treturn '0' . $element;\r\n\t} else {\r\n\t\treturn $element;\r\n\t}\r\n}","location":"","type":"php","filters":"","changed_filters":"","scope":"shortcode","description":"PHP script to display attendance report","attributes":"","tags":[]}]}